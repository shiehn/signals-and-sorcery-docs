# Documentation Deployment Guide

This guide explains how to update and deploy the Signals & Sorcery documentation, including managing download links.

## Architecture Overview

The documentation system uses two Git repositories:

1. **signals-and-sorcery-docs/** (this repo) - VuePress source files
   - Contains markdown documentation in `src/`
   - Build configuration in `src/.vuepress/`
   - This is where you edit content

2. **dawnet-docs-gh-pages/** - Built HTML output
   - Generated by VuePress build process
   - Served by GitHub Pages from `gh-pages` branch
   - DO NOT edit files here directly - they get overwritten by builds

## Download Link System

### How It Works

Download links are **hardcoded directly in markdown**, NOT dynamically loaded via JavaScript.

**Location:** `src/getting-started/README.md`

```markdown
#### 2. Download Signals & Sorcery

Choose the version for your system:

- **[Apple Silicon Mac (M1/M2/M3/M4)](https://storage.googleapis.com/docs-assets/signals-and-sorcery-0_12_0-arm64.dmg)** - Download for Apple Silicon Macs (v0.12.0)
- **Intel Mac** - Coming soon

**Note:** The app is signed and notarized by Apple for security.
```

### Why Hardcoded Links?

- **Reliable:** No client-side JavaScript that can fail to load
- **SEO-friendly:** Links visible to search engines and crawlers
- **Simple:** Direct markdown links, no complex fetching logic
- **Fast:** No additional HTTP requests on page load
- **Auto-updated:** The release script uses regex to automatically update these links

### What About downloads.json?

The release script **also** generates and updates `downloads.json`. This file serves different purposes:

- **Version API:** External tools can query current version info
- **Release History:** Maintains last 10 versions in `versions` array
- **Metadata:** Stores file sizes, dates, and download URLs
- **Future Use:** Could be used for update checkers, analytics, etc.

**Location:** `dawnet-docs-gh-pages/downloads.json`

The website does NOT use JavaScript to load from downloads.json for display - the hardcoded markdown links are used instead for reliability.

### Avoid Dynamic Loading for Display

❌ **DO NOT** use this pattern for the main download link:
```html
<div id="download-links"><p>Loading download links...</p></div>
```
With JavaScript fetching `downloads.json` - this approach is unreliable in the VuePress build system and not needed since the release script auto-updates the markdown.

## Updating Download Links for New Releases

**IMPORTANT:** The release process is **fully automated** via the release script!

### Automated Release Process (Recommended)

When you want to release a new version, run:

```bash
cd /Users/stevehiehn/sas-m4l-project/sas-assistant

# For minor version bump (0.12.0 → 0.13.0)
npm run release

# Or specify version type
npm run release:major  # 0.12.0 → 1.0.0
npm run release:minor  # 0.12.0 → 0.13.0
npm run release:patch  # 0.12.0 → 0.12.1
```

**What the release script does automatically:**

1. ✅ Runs tests
2. ✅ Bumps version in package.json
3. ✅ Builds the DMG
4. ✅ Uploads DMG to Google Cloud Storage (`gs://docs-assets/`)
5. ✅ Updates `downloads.json` with new version info
6. ✅ **Updates hardcoded download links** in `src/getting-started/README.md` via regex
7. ✅ Rebuilds VuePress documentation
8. ✅ Deploys to GitHub Pages (both main and gh-pages branches)
9. ✅ Creates git tag
10. ✅ Optionally creates GitHub release

**Release script location:** `sas-assistant/scripts/release.js`

The script automatically finds and updates download links using this regex:
```javascript
/https:\/\/storage\.googleapis\.com\/docs-assets\/signals-and-sorcery-\d+_\d+_\d+-arm64\.dmg/g
```

### Manual Release Process (Not Recommended)

⚠️ Only use if the automated release script fails.

#### Step 1: Upload DMG to Google Cloud Storage

```bash
# Upload the new DMG file
gsutil cp signals-and-sorcery-0_13_0-arm64.dmg gs://docs-assets/

# Make it publicly accessible
gsutil acl ch -u AllUsers:R gs://docs-assets/signals-and-sorcery-0_13_0-arm64.dmg
```

#### Step 2: Update the Download Link in Markdown

Edit `src/getting-started/README.md`:

```markdown
- **[Apple Silicon Mac (M1/M2/M3/M4)](https://storage.googleapis.com/docs-assets/signals-and-sorcery-0_13_0-arm64.dmg)** - Download for Apple Silicon Macs (v0.13.0)
```

Update:
1. The URL to point to new version (e.g., `0_13_0`)
2. The version number in parentheses (e.g., `v0.13.0`)

#### Step 3: Build and Deploy

```bash
cd /Users/stevehiehn/sas-m4l-project/signals-and-sorcery-docs

# Build VuePress site (output goes to ../dawnet-docs-gh-pages)
npm run build

# Deploy to GitHub Pages
cd ../dawnet-docs-gh-pages

# Commit and push to main branch
git add -A
git commit -m "Update download link to v0.13.0"
git push origin main

# Deploy to gh-pages branch (this is what GitHub Pages serves)
git checkout gh-pages
git merge main -m "Merge main: Update download link to v0.13.0"
git push origin gh-pages
git checkout main

# Commit source changes
cd ../signals-and-sorcery-docs
git add src/getting-started/README.md
git commit -m "Update download link to v0.13.0"
git push origin main
```

#### Step 4: Verify Deployment

Wait 2-3 minutes for GitHub Pages to propagate, then check:
- https://signalsandsorcery.com/getting-started/

The download link should point to the new version.

## Complete Deployment Workflow

### For Documentation Content Updates

When updating documentation content (not download links):

```bash
cd /Users/stevehiehn/sas-m4l-project/signals-and-sorcery-docs

# 1. Edit markdown files in src/
# 2. Build the site
npm run build

# 3. Deploy
npm run deploy  # This runs the deploy script from package.json

# 4. Also deploy to gh-pages
cd ../dawnet-docs-gh-pages
git checkout gh-pages
git merge main
git push origin gh-pages
git checkout main

# 5. Commit source changes
cd ../signals-and-sorcery-docs
git add .
git commit -m "Update documentation"
git push origin main
```

### For Download Link Updates

Follow "Step 3: Build and Deploy" above after editing the markdown link.

## Repository Details

### signals-and-sorcery-docs/

```
signals-and-sorcery-docs/
├── src/
│   ├── .vuepress/
│   │   ├── config.js          # VuePress configuration
│   │   ├── enhanceApp.js      # Client-side enhancements (AVOID for download links)
│   │   └── public/            # Static assets (images, etc.)
│   ├── getting-started/
│   │   └── README.md          # ⭐ DOWNLOAD LINKS LIVE HERE
│   ├── prologue/
│   │   └── README.md          # Overview page
│   └── [other sections]/
├── package.json               # npm scripts: dev, build, deploy
└── DEPLOYMENT.md             # This file
```

### dawnet-docs-gh-pages/

```
dawnet-docs-gh-pages/
├── assets/                    # Built JavaScript and CSS
├── getting-started/
│   └── index.html            # Built HTML (contains download links)
├── downloads.json            # ❌ NOT USED (legacy file, can be ignored)
└── [other built files]/
```

**Branches:**
- `main` - Stores built output
- `gh-pages` - GitHub Pages serves from here (must be in sync with main)

## Build Scripts

From `package.json` in signals-and-sorcery-docs:

```json
{
  "scripts": {
    "dev": "vuepress dev src",
    "build": "vuepress build src && cp -r src/.vuepress/dist/* ./../dawnet-docs-gh-pages",
    "deploy": "cd ./../dawnet-docs-gh-pages && git add . -f && git commit -m 'deploy' && git push"
  }
}
```

- `npm run dev` - Start local dev server (http://localhost:8080)
- `npm run build` - Build site and copy to dawnet-docs-gh-pages
- `npm run deploy` - Commit and push to main (⚠️ doesn't deploy to gh-pages branch)

## Common Issues and Solutions

### Issue: Download links show "Loading..." but never populate

**Cause:** Using dynamic JavaScript loading instead of hardcoded markdown links

**Solution:** Replace dynamic div with hardcoded markdown link (see "Download Link System" above)

### Issue: Changes don't appear on live site

**Possible causes:**

1. **Forgot to push to gh-pages branch**
   ```bash
   cd dawnet-docs-gh-pages
   git checkout gh-pages
   git merge main
   git push origin gh-pages
   ```

2. **GitHub Pages cache** - Wait 2-3 minutes, then hard refresh browser (Cmd+Shift+R)

3. **Build didn't copy files**
   ```bash
   cd signals-and-sorcery-docs
   npm run build
   # Check that files were copied to ../dawnet-docs-gh-pages
   ```

### Issue: Old version number still showing

**Cause:** Forgot to update the version number in markdown text

**Solution:** Edit `src/getting-started/README.md` and update BOTH:
- The URL: `signals-and-sorcery-0_13_0-arm64.dmg`
- The display text: `(v0.13.0)`

## Testing Locally Before Deploy

```bash
cd signals-and-sorcery-docs

# Start dev server
npm run dev

# Visit http://localhost:8080/getting-started/
# Verify download link appears correctly
```

## GitHub Pages Configuration

**Repository:** shiehn/dawnet-docs-gh-pages

**Settings:**
- Source: Deploy from `gh-pages` branch
- Custom domain: signalsandsorcery.com
- CNAME file: Contains `signalsandsorcery.com`

## Quick Reference: Release Checklist

When releasing a new app version:

- [ ] Upload DMG to Google Cloud Storage
- [ ] Update download link URL in `src/getting-started/README.md`
- [ ] Update version number in display text
- [ ] Run `npm run build`
- [ ] Commit and push to both `main` and `gh-pages` branches
- [ ] Verify live site shows new version
- [ ] Commit source changes to signals-and-sorcery-docs

## Important Notes

1. **Always deploy to BOTH branches:** `main` and `gh-pages` in dawnet-docs-gh-pages
2. **Download links are markdown links** - No JavaScript required
3. **Test locally first** - Use `npm run dev` to preview changes
4. **Wait for GitHub Pages** - Changes can take 2-3 minutes to propagate
5. **Keep source and output in sync** - Commit to both repos after deployment

---

**Last Updated:** 2025-10-20
**Current Version:** v0.12.0
